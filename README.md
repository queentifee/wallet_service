# Wallet Service API

A backend wallet system built with **NestJS**, **TypeScript**, **PostgreSQL**, and **TypeORM**.  
Features:

- Google OAuth 2.0 sign-in (JWT issuance)
- Wallet creation per user
- Paystack integration for deposits
- Wallet-to-wallet transfers
- Transaction history
- API keys for service-to-service access (with permissions, expiry, and rollover)
- Robust error handling & idempotency

---

## Requirements

- Node.js >= 20  
- npm >= 9  
- NestJS CLI  
- PostgreSQL (local)  
- ngrok (for Paystack webhooks)

---

## Installation & Setup

1. Clone the repository:

```bash
git clone <repository_url>
cd wallet-service
Install dependencies:

bash
Copy code
npm install
Setup local PostgreSQL database:

sql
Copy code
CREATE DATABASE wallet_service;
Update environment variables in .env (see below).

Environment Variables
Create a .env file in the root folder:

dotenv
Copy code
PORT=3000
JWT_SECRET=your_jwt_secret
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
PAYSTACK_SECRET_KEY=sk_test_xxxxx
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres
DATABASE_NAME=wallet_service
Running the Application
bash
Copy code
# Run in development mode
npm run start:dev
Start ngrok for webhook testing:

bash
Copy code
ngrok http 3000
Use the HTTPS URL generated by ngrok for Paystack webhook configuration.

API Endpoints
Authentication (Google OAuth)
1. Redirect to Google for login

bash
Copy code
GET /auth/google
2. Callback endpoint

bash
Copy code
GET /auth/google/callback
Creates a new user if not existing

Returns a JWT token:

json
Copy code
{
  "access_token": "<jwt_token>"
}
API Key Management
Create API Key

bash
Copy code
POST /keys/create
Payload:

json
Copy code
{
  "name": "wallet-service",
  "permissions": ["deposit", "transfer", "read"],
  "expiry": "1D"
}
Response:

json
Copy code
{
  "api_key": "sk_live_xxxxx",
  "expires_at": "2025-01-01T12:00:00Z"
}
Rollover Expired API Key

bash
Copy code
POST /keys/rollover
Payload:

json
Copy code
{
  "expired_key_id": "7b74241d-911-403d-af35-7501df3446d9",
  "expiry": "1M"
}
Wallet Deposit (Paystack)
bash
Copy code
POST /wallet/deposit
Auth: JWT or API Key with deposit permission

Payload:

json
Copy code
{
  "amount": 5000
}
Response:

json
Copy code
{
  "reference": "TRX123456",
  "authorization_url": "https://paystack.co/checkout/..."
}
Use this URL to pay. Wallet balance updates only after webhook confirmation.

Paystack Webhook
bash
Copy code
POST /wallet/paystack/webhook
Validate Paystack signature

Update transaction and wallet balance atomically

Idempotent (no double credit)

Response:

json
Copy code
{
  "status": true
}
Get Wallet Balance
bash
Copy code
GET /wallet/balance
Auth: JWT or API Key with read permission

Response:

json
Copy code
{
  "balance": 15000
}
Wallet Transfer
arduino
Copy code
POST /wallet/transfer
Auth: JWT or API Key with transfer permission

Payload:

json
Copy code
{
  "wallet_number": "4566678954356",
  "amount": 3000
}
Response:

json
Copy code
{
  "status": "success",
  "message": "Transfer completed",
  "fromTx": "trf_xxx",
  "toTx": "trf_xxx_c"
}
Transfers are atomic

Prevents insufficient balance

Creates two transaction entries (debit & credit)

Transaction History
bash
Copy code
GET /wallet/transactions
Auth: JWT or API Key with read permission

Query Parameters (optional):

page (default 1)

limit (default 20)

type (deposit, transfer_debit, transfer_credit)

status (success, pending, failed)

Response:

json
Copy code
{
  "data": [
    {
      "id": "1",
      "reference": "TRX123456",
      "type": "deposit",
      "status": "success",
      "amount": 5000,
      "senderWalletNumber": null,
      "receiverWalletNumber": "1234567890",
      "createdAt": "2025-12-09T10:00:00Z"
    }
  ],
  "page": 1,
  "limit": 20,
  "total": 1
}
Error Handling
Common errors:

Error	Status Code	Description
Insufficient balance	400	Wallet has insufficient funds
Invalid API key	401	API key not found
Expired API key	403	API key expired
Missing permissions	403	API key missing required permission
Invalid webhook signature	400	Webhook request not from Paystack
Duplicate transaction reference	400	Paystack reference already used

Notes
Amounts are stored in kobo internally; converted to Naira in API responses.

Wallet is created automatically when a new user signs in via Google.

Maximum 5 active API keys per user.

Paystack webhooks must be configured with your ngrok HTTPS URL for local development.

## ðŸ”— Links

- **Live API**: https://wallet-service-p5yz.onrender.com
- **Documentation**: https://wallet-service-p5yz.onrender.com/api/docs
- **GitHub**: https://github.com/queentifee/wallet-service

License
MIT License